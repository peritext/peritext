<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for connectors/filesystem/connector.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">All files</a> / <a href="index.html">connectors/filesystem</a> connector.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">92.68% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>114/123</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">83.75% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>67/80</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">96.67% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>29/30</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">91.18% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>93/102</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">359x</span>
<span class="cline-any cline-yes">359x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">149x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">149x</span>
<span class="cline-any cline-yes">356x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">316x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">316x</span>
<span class="cline-any cline-yes">128x</span>
<span class="cline-any cline-yes">128x</span>
<span class="cline-any cline-yes">128x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">128x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">188x</span>
<span class="cline-any cline-yes">149x</span>
<span class="cline-any cline-yes">149x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">356x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">149x</span>
<span class="cline-any cline-yes">149x</span>
<span class="cline-any cline-yes">307x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">149x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">39x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16x</span>
<span class="cline-any cline-yes">16x</span>
<span class="cline-any cline-yes">16x</span>
<span class="cline-any cline-yes">16x</span>
<span class="cline-any cline-yes">16x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16x</span>
<span class="cline-any cline-yes">16x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14x</span>
<span class="cline-any cline-yes">9x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17x</span>
<span class="cline-any cline-yes">17x</span>
<span class="cline-any cline-yes">17x</span>
<span class="cline-any cline-yes">264x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17x</span>
<span class="cline-any cline-yes">17x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-yes">208x</span>
<span class="cline-any cline-yes">208x</span>
<span class="cline-any cline-yes">208x</span>
<span class="cline-any cline-yes">204x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17x</span>
<span class="cline-any cline-yes">17x</span>
<span class="cline-any cline-yes">16x</span>
<span class="cline-any cline-yes">12x</span>
<span class="cline-any cline-yes">12x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">35x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">234x</span>
<span class="cline-any cline-yes">234x</span>
<span class="cline-any cline-yes">234x</span>
<span class="cline-any cline-yes">234x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import {readFile, readdir, lstatSync, mkdir, exists, writeFile, unlink} from 'fs';
import {resolve, extname, basename, join as joinPath} from 'path';
import {map as asyncMap, reduce as asyncReduce} from 'async';
import removeFolderRecursively from 'rmdir';
&nbsp;
const analyseElement = function(fileName, absPath) {
  const path = joinPath(absPath, fileName);
  return {
    name: fileName,
    path,
    type: (lstatSync(path).isDirectory()) ? 'directory' : 'file',
    extname: extname(path)
  };
};
&nbsp;
const analyseContents = function(filesList, absPath) {
  if (!filesList) <span class="missing-if-branch" title="if path not taken" >I</span>{
<span class="cstat-no" title="statement not covered" >    return undefined;</span>
  }
  return filesList.map((fileName) =&gt; {
    return analyseElement(fileName, absPath);
  });
};
&nbsp;
&nbsp;
// recursive fs element parser
const parseElement = function({path = <span class="branch-0 cbranch-no" title="branch not covered" >'', element, parseFiles, depth, actualDepth, acceptedExtensions}, callback) </span>{
  // file to parse
  if (element.type === 'file' &amp;&amp; parseFiles === true &amp;&amp; acceptedExtensions.indexOf(element.extname) &gt; -1) {
    try {
      readFile(path, 'utf8', function(err, str) {
        if (err) <span class="missing-if-branch" title="if path not taken" >I</span>{
<span class="cstat-no" title="statement not covered" >          return callback(err, undefined);</span>
        }
        return callback(null, Object.assign({}, element, {stringContents: str}));
      });
    } catch (exception) {
<span class="cstat-no" title="statement not covered" >      callback(null, element);</span>
    }
&nbsp;
&nbsp;
  // dir to parse
  } else if (element.type === 'directory' &amp;&amp; (actualDepth &lt; depth || depth === true)) {
    readdir(element.path + '/', function(err, files) {
      const children = analyseContents(files, path)
                      .filter((child)=&gt;{
                        return child.type === 'directory' || acceptedExtensions.indexOf(child.extname) &gt; -1;
                      });
      const newDepth = actualDepth + 1;
      asyncMap(children, function(elem, colback) {
        parseElement({element: elem, path: path + '/' + elem.name, parseFiles, depth, actualDepth: newDepth, acceptedExtensions}, colback);
      }, function(error, otherChildren) {
        return callback(error, Object.assign({}, element, {children: otherChildren}));
      });
    });
  // default return element as it was input
  } else {
    return callback(null, Object.assign({}, element));
  }
};
&nbsp;
// cRud
export function readFromPath({path = [], params, depth = 1, parseFiles = false, acceptedExtensions = ['.md', '.bib', '.css', '.js']}, callback) {
  const resolvedPath = (Array.isArray(path)) ? path.join('/') : path;
  const finalPath = resolve(params.basePath) + '/' + resolvedPath;
  let element;
  const name = basename(finalPath);
&nbsp;
  try {
    element = {
      name: name,
      path: finalPath,
      type: (lstatSync(finalPath).isDirectory()) ? 'directory' : 'file',
      extname: extname(name)
    };
  }catch (err) {
    return callback(err, undefined);
  }
&nbsp;
  if (element.type === 'directory') {
    return parseElement({path: finalPath, element, parseFiles, depth, actualDepth: 0, acceptedExtensions}, callback);
  } else if (acceptedExtensions.indexOf(element.extname) &gt; -1) {
    readFile(finalPath, 'utf8', (err, str) =&gt; {
      if (err) <span class="missing-if-branch" title="if path not taken" >I</span>{
<span class="cstat-no" title="statement not covered" >        return callback(err, undefined);</span>
      }
      return callback(null, Object.assign({}, element, {stringContents: str}));
    });
  } else {
    return callback(new Error('the file extension is not accepted'), undefined);
  }
}
&nbsp;
// Crud
export function createFromPath({path = '', params, type = 'file', stringContents = '', overwrite = false}, callback) {
  const resolvedPath = (</span>Array.isArray(path)) ? <span class="branch-0 cbranch-no" title="branch not covered" >path.join('/') : path;
  const finalPath = resolve(params.basePath) + '/' + resolvedPath;
  const pathSteps = finalPath.split('/').filter((thatPath)=&gt; {return thatPath.length &gt; 0;});
  // first check-or-create path folders
  const activePath = '/';
  asyncReduce(pathSteps, activePath, function(inputMemo, pathStep, cback) {
    // case : not end of path, walking through
    if (pathStep !== pathSteps[pathSteps.length - 1]) {
      const memo = inputMemo + pathStep + '/';
      exists(memo, function(isThere) {
        if (isThere) {
          cback(null, memo);
        }else {
          mkdir(memo, function(err) {
            cback(err, memo);
          });
        }
      });
    // case : end of path
    } else {
      cback(null, inputMemo + pathStep);
    }
&nbsp;
  }, function(err, result) {
    // check if element already exists
    exists(finalPath, function(isThere) {
      if ((isThere &amp;&amp; overwrite === true) || !isThere) {
        if (type === 'file') {
          writeFile(finalPath, stringContents, 'utf8', function(error) {
            callback(error);
          });
        }else if (type === 'directory') {
          mkdir(finalPath, function(error) {
            callback(error);
          });
        }else <span class="missing-if-branch" title="else path not taken" >E</span>{
<span class="cstat-no" title="statement not covered" >          callback(new Error('No element type matching'));</span>
        }
      }else {
        callback(new Error('File/directory already exists and overwrite option is set to false'));
      }
    });
  });
}
&nbsp;
// crUd
export function updateFromPath({path = <span class="branch-0 cbranch-no" title="branch not covered" >'', params, stringContents = ''}, callback) </span>{
  const resolvedPath = (</span>Array.isArray(path)) ? <span class="branch-0 cbranch-no" title="branch not covered" >path.join('/') : path;
  const finalPath = resolve(params.basePath + '/' + resolvedPath);
  exists(finalPath, function(isThere) {
    if (isThere) {
      const pathSteps = finalPath.split('/').filter((thatPath)=&gt; {return thatPath.length &gt; 0;});
      const elementName = pathSteps.pop();
      const element = analyseElement(elementName, '/' + pathSteps.join('/'));
      if (element.type === 'directory') <span class="missing-if-branch" title="if path not taken" >I</span>{
<span class="cstat-no" title="statement not covered" >        callback(new Error('cannot update directories'));</span>
      } else if (element.type === 'file') {
        writeFile(finalPath, stringContents, function(err) {
          callback(err);
        });
      }
    }else {
      callback(new Error('Path does not exists'));
    }
  });
}
&nbsp;
// cruD
export function deleteFromPath({path = '', params}, callback) {
  const resolvedPath = (</span>Array.isArray(path)) ? <span class="branch-0 cbranch-no" title="branch not covered" >path.join('/') : path;
  const finalPath = resolve(params.basePath) + '/' + resolvedPath;
  exists(finalPath, function(isThere) {
    if (isThere) {
      const pathSteps = finalPath.split('/').filter((thatPath) =&gt; {return thatPath.length &gt; 0;});
      const elementName = pathSteps.pop();
      const element = analyseElement(elementName, '/' + pathSteps.join('/'));
      if (element.type === 'directory') {
        removeFolderRecursively(finalPath, function(err) {
          callback(err);
        });
      }else <span class="cstat-no" title="statement not covered" ><span class="missing-if-branch" title="else path not taken" >E</span></span>if (element.type === 'file') <span class="missing-if-branch" title="if path not taken" >I</span>{
<span class="cstat-no" title="statement not covered" >        unlink(finalPath, <span class="fstat-no" title="function not covered" >function(</span>err) {</span>
<span class="cstat-no" title="statement not covered" >          callback(err);</span>
        });
      }
    }else {
      callback(new Error('Path does not exists'));
    }
  });
}
&nbsp;
// asset resolver
// pretty useless for fs connector
// but kept for architecture consistency
// because it will be a more complex process for other connectors
// WIP TODO QUESTION : should it check for resource availability ?
export function getAssetUri({path, params}, callback) {
  const resolvedPath = (</span>Array.isArray(path)) ? <span class="branch-0 cbranch-no" title="branch not covered" >path.join('/') : path;
  const finalPath = resolve(params.basePath) + '/' + resolvedPath;
  return callback(null, finalPath);
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sun Jul 24 2016 16:20:22 GMT+0200 (CEST)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
