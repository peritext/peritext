<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for resolvers/resolveSectionAgainstModels/index.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">All files</a> / <a href="index.html">resolvers/resolveSectionAgainstModels</a> index.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">83.33% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>35/42</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">80.95% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>17/21</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>5/5</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">82.5% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>33/40</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20x</span>
<span class="cline-any cline-yes">20x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">160x</span>
<span class="cline-any cline-yes">160x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">160x</span>
<span class="cline-any cline-yes">3370x</span>
<span class="cline-any cline-yes">3370x</span>
<span class="cline-any cline-yes">55x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3315x</span>
<span class="cline-any cline-yes">1445x</span>
<span class="cline-any cline-yes">1870x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3370x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">485x</span>
<span class="cline-any cline-yes">485x</span>
<span class="cline-any cline-yes">440x</span>
<span class="cline-any cline-yes">440x</span>
<span class="cline-any cline-yes">25x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">440x</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-yes">80x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">80x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">380x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">440x</span>
<span class="cline-any cline-yes">260x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">45x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">485x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">620x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import {getResourceModel, resolvePropAgainstType} from './../../utils/modelUtils';
import {getMetaValue} from './../../utils/sectionUtils';
import {serializeHtmlMeta} from './../../resolvers/htmlMetaTemplateSerializer';
&nbsp;
export function resolveSectionAgainstModels(section, models, callback) {
  const errors = [];
  // validate resources
  section.resources = section.resources.map((resource) =&gt;{
    const model = getResourceModel(resource.bibType, models.resourceModels);
    if (model) {
      // populate resource model with input resource data
      return model.properties.reduce((resolvedResource, propModel) =&gt; {
        const key = propModel.key;
        if (propModel.required &amp;&amp; !resource[key]) {
          errors.push({
            type: 'error',
            preciseType: 'invalidResource',
            sectionCiteKey: getMetaValue(section.metadata, 'general', 'citeKey'),
            message: 'property ' + key + ' is required in resource ' + resource.citeKey + '(bibType: ' + resource.bibType + ') and not present'
          });
        }else if (resource[key]) {
          resolvedResource[key] = resolvePropAgainstType(resource[key], propModel.valueType, propModel);
        } else if (propModel.default) <span class="missing-if-branch" title="if path not taken" >I</span>{
<span class="cstat-no" title="statement not covered" >          resource[key] = propModel.default;</span>
        }
        return resolvedResource;
      }, {});
    }
<span class="cstat-no" title="statement not covered" >    errors.push({</span>
      type: 'error',
      preciseType: 'invalidResource',
      sectionCiteKey: getMetaValue(section.metadata, 'general', 'citeKey'),
      message: 'Could not find suitable data model for resource ' + resource.citeKey
    });
<span class="cstat-no" title="statement not covered" >    return {};</span>
  });
&nbsp;
  // validate metadata
  section.metadata = section.metadata.map((metadata) =&gt; {
    // resolve unicity
    const model = models.metadataModels[metadata.domain][metadata.key];
    if (model) {
      const uniquePb = model.unique &amp;&amp; Array.isArray(metadata.value) &amp;&amp; metadata.value.length &gt; 1;
      if (uniquePb) {
        errors.push({
          type: 'error',
          preciseType: 'invalidMetadata',
          sectionCiteKey: getMetaValue(section.metadata, 'general', 'citeKey'),
          message: metadata.key + ' value was set more than once for section ' + getMetaValue(section.metadata, 'general', 'title')
        });
        metadata.value = metadata.value[0];
      }
&nbsp;
      if (Array.isArray(metadata.value)) {
        metadata.value = metadata.value.map((val)=&gt; {
          if (typeof metadata.value === 'string') <span class="missing-if-branch" title="if path not taken" >I</span>{
<span class="cstat-no" title="statement not covered" >            return resolvePropAgainstType(val, model.valueType, model);</span>
          }
          return val;
        });
&nbsp;
      }else if (typeof metadata.value === 'string') {
        metadata.value = resolvePropAgainstType(metadata.value, model.valueType, model);
      }
&nbsp;
      if (model.headTemplate) {
        metadata.htmlHead = serializeHtmlMeta(metadata, model.headTemplate);
      }
&nbsp;
    }else {
      errors.push({
        type: 'warning',
        preciseType: 'invalidMetadata',
        sectionCiteKey: getMetaValue(section.metadata, 'general', 'citeKey'),
        message: metadata.domain + ' metadata property ' + metadata.key + ' is invalid in section ' + getMetaValue(section.metadata, 'general', 'title') + ' and therefore was not taken into account'
      });
    }
&nbsp;
    return metadata;
  });
&nbsp;
  // defaults
  for (const key in models.metadataModels.general) {
    if (models.metadataModels.general[key].default) <span class="missing-if-branch" title="if path not taken" >I</span>{
      const p</span>resent = <span class="cstat-no" title="statement not covered" >getMetaValue(section.metadata, 'general', key);
<span class="cstat-no" title="statement not covered" ></span>      if (!present) <span class="missing-if-branch" title="if path not taken" >I</span>{
<span class="cstat-no" title="statement not covered" >        section.metadata.push({</span>
          domain: 'general',
          key,
          value: models.metadataModels.general[key].default
        });
      }
    }
  }
  return callback(null, {errors, section});
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sun Jul 24 2016 16:20:22 GMT+0200 (CEST)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
